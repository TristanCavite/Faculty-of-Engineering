<template>
  <ClientOnly>
    <VCalendar
      :trim-weeks="props.trimWeeks || true"
      :is-dark="$colorMode.value == 'dark'"
      v-bind="$attrs"
      :attributes="mergedAttributes"             
      @dayclick="onDayClick"                     
      @day-click="onDayClick"
    >
      <template v-for="(_, slot) in $slots" #[slot]="scope">
        <slot :name="slot" v-bind="scope" />
      </template>
    </VCalendar>
  </ClientOnly>
</template>

<script lang="ts" setup>
import type { Calendar } from "v-calendar";
import { computed, ref } from "vue";
import dayjs from "dayjs";

defineOptions({ inheritAttrs: false });

interface Props extends /* @vue-ignore */ Partial<InstanceType<typeof Calendar>["$props"]> {
  attributes?: any[];
}


type DotEvent = { date: Date | string; color?: string; label?: string };
interface Props extends /* @vue-ignore */ Partial<InstanceType<typeof Calendar>["$props"]> {}

const props = withDefaults(defineProps<Props & {
  trimWeeks?: boolean;
  clickHighlight?: boolean;
  clickLabel?: string;
  dotEvents?: DotEvent[];
  selectedDate?: Date | null;
}>(), {
    trimWeeks: true,
  clickHighlight: true,
  clickLabel: "Selected date",
  dotEvents: () => [],
  attributes: () => [], 
});

const toDate = (d: unknown): Date => {
  if (d instanceof Date) return d;
  if (typeof d === 'string') return dayjs(d).toDate();
  if (d && typeof (d as any).toDate === 'function') return (d as any).toDate(); // Firestore Timestamp
  return dayjs(d as any).toDate();
};
const clickedDate = ref<Date | null>(null);

const dynamicDots = computed(() =>
  (props.dotEvents ?? []).map((e, i) => ({
    key: `dot-${i}-${dayjs(toDate(e.date)).format('YYYY-MM-DD')}`,
    dates: toDate(e.date),

    // üî¥ inline style beats theme variables
    dot: {
      style: {
        backgroundColor: '#ef4444',
        borderColor: '#ef4444',
      },
    },

    popover: e.label ? { label: e.label } : undefined,
  }))
)

watch(() => props.selectedDate, (val) => {
  clickedDate.value = val ?? null;
});

// Merge parent-provided attributes with our click highlight
const mergedAttributes = computed(() => {
  const base = (props.attributes as any[]) ?? [];
  const extra = props.clickHighlight && clickedDate.value
    ? [{
        key: "__clicked__",
        highlight: true,
        dates: clickedDate.value,
        popover: { label: props.clickLabel },
      }]
    : [];
  return [...base, ...dynamicDots.value, ...extra]; // ‚Üê include dynamicDots here
});

const emit = defineEmits<{
  (e: 'date-click', date: Date): void;
  (e: 'dayclick', payload: any): void; // optional: forward native
  (e: "update:selectedDate", date: Date | null): void;
}>();

function onDayClick(payload: any) {
  const dt: Date | null =
    payload instanceof Date ? payload :
    payload?.date instanceof Date ? payload.date :
    payload?.day?.date instanceof Date ? payload.day.date :
    null;

  if (!dt) return;
  clickedDate.value = dt;
  emit("date-click", dt);
  emit("dayclick", payload);
  emit("update:selectedDate", dt);        // üëà keep parent in sync
}
</script>

<style>
  :root {
    --vc-font-family: var(--font-sans);
    --vc-rounded-full: var(--radius);
    --vc-font-bold: 500;
    --vc-font-semibold: 600;
    --vc-text-lg: 16px;
  }

  .vc-light,
  .vc-dark {
    --vc-bg: theme("colors.background");
    --vc-border: theme("colors.border");
    --vc-focus-ring: 0 0 0 3px hsl(var(--primary) / 30%);
    --vc-weekday-color: theme("colors.muted.foreground");
    --vc-popover-content-color: theme("colors.popover.foreground");
    --vc-hover-bg: theme("colors.accent.DEFAULT");
    --vc-popover-content-bg: theme("colors.popover.DEFAULT");
    --vc-popover-content-border: theme("colors.border");
    --vc-header-arrow-hover-bg: theme("colors.accent.DEFAULT");
    --vc-weeknumber-color: theme("colors.muted.foreground");
    --vc-nav-hover-bg: theme("colors.accent.DEFAULT");

    --vc-nav-item-active-color: theme("colors.primary.foreground");
    --vc-nav-item-active-bg: theme("colors.primary.DEFAULT");

    &.vc-attr,
    & .vc-attr {
      /* --vc-content-color: theme("colors.primary.DEFAULT"); */
      --vc-highlight-outline-bg: theme("colors.primary.DEFAULT");
      --vc-highlight-outline-border: theme("colors.primary.DEFAULT");
      --vc-highlight-outline-content-color: theme("colors.primary.foreground");
      --vc-highlight-light-bg: var(--vc-accent-200); /* Highlighted color between two dates */
      --vc-highlight-light-content-color: theme("colors.secondary.foreground");
      --vc-highlight-solid-bg: theme("colors.primary.DEFAULT");
      --vc-highlight-solid-content-color: theme("colors.primary.foreground");
    }
  }
  .vc-day .vc-attr .vc-dot {
  background-color: #800e0e !important;
  border-color: #800e0e !important;
}

  .vc-blue {
    --vc-accent-200: theme("colors.primary.DEFAULT / 20%");
    --vc-accent-400: theme("colors.primary.DEFAULT");
    --vc-accent-500: theme("colors.primary.DEFAULT");
    --vc-accent-600: theme("colors.primary.DEFAULT / 70%");
  }

  .dark {
    .vc-blue {
      --vc-accent-200: theme("colors.primary.DEFAULT / 20%");
      --vc-accent-400: theme("colors.primary.DEFAULT");
      --vc-accent-500: theme("colors.primary.DEFAULT / 70%");
    }
  }
  .vc-header .vc-title {
    @apply font-medium;
  }
  .vc-weekdays {
    @apply my-2 font-normal;
  }
  .vc-day-content,
  .vc-day,
  .vc-highlight {
    @apply h-9 w-9 rounded-md;
  }
  .vc-focus {
    @apply focus-within:shadow-none;
  }
  .vc-day {
    @apply mb-1.5;
  }

  .vc-base-icon {
    @apply h-4 w-4 stroke-1;
  }
  .vc-header .vc-arrow,
  .vc-nav-arrow {
    @apply h-7 w-7 rounded-md;
    border: 1px solid hsl(var(--border));
  }
  .vc-header .vc-prev,
  .vc-header .vc-next {
    @apply border;
  }
  .weekday-position-1 .vc-highlights {
    @apply rounded-l-md;
  }
  .weekday-position-7 .vc-highlights {
    @apply rounded-r-md;
  }
  .vc-highlight-bg-light {
    @apply bg-accent;
  }
  .vc-nav-item {
    @apply font-medium;
  }
  .vc-header .vc-title-wrapper {
    @apply decoration-accent-foreground/60 underline-offset-2 hover:underline;
  }
  .vc-highlights + .vc-day-content {
    @apply hover:bg-accent/5;
  }
</style>